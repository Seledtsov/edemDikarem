<?
ini_set('magic_quotes_runtime', 'Off');
$xmlstr = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
	"."<CLIENT_AREA><L_STATIC_LIST><STATICS><ID>90</ID><NAME>Тестовая страница</NAME></STATICS><STATICS><ID>81</ID><NAME>Детализация бизнес-процессов кредитования в xBank</NAME></STATICS><STATICS><ID>80</ID><NAME>Интернет-решения</NAME></STATICS><STATICS><ID>79</ID><NAME>Хранилища данных</NAME></STATICS><STATICS><ID>78</ID><NAME>Регламентное описание бизнес-процессов</NAME></STATICS><STATICS><ID>77</ID><NAME>Тиражирование данных</NAME></STATICS><STATICS><ID>76</ID><NAME>Прием и контроль информации</NAME></STATICS><STATICS><ID>75</ID><NAME>Описание отчетных форм</NAME></STATICS><STATICS><ID>74</ID><NAME>Обеспечение информационной безопасности</NAME></STATICS><STATICS><ID>73</ID><NAME>Описание xTool</NAME></STATICS><STATICS><ID>72</ID><NAME>Система безопасности. Управление доступом. Аудит</NAME></STATICS><STATICS><ID>89</ID><NAME>xBank/Кредитование</NAME></STATICS><STATICS><ID>71</ID><NAME>Генератор отчетности и документов</NAME></STATICS><STATICS><ID>70</ID><NAME>Технология проведения операций. Возможности настройки</NAME></STATICS><STATICS><ID>69</ID><NAME>Кредитные линии</NAME></STATICS><STATICS><ID>68</ID><NAME>Процентные ставки</NAME></STATICS><STATICS><ID>67</ID><NAME>Группы риска.  Резервирование (РВПС, РВП)</NAME></STATICS><STATICS><ID>66</ID><NAME>Работа с обеспечением</NAME></STATICS><STATICS><ID>65</ID><NAME>Ведение кредитного договора</NAME></STATICS><STATICS><ID>64</ID><NAME>Предкредитная обработка</NAME></STATICS><STATICS><ID>63</ID><NAME>Нормативно-справочная информация</NAME></STATICS><STATICS><ID>62</ID><NAME>Описание xBank/Кредитование</NAME></STATICS><STATICS><ID>88</ID><NAME>Интерфейсы основной АБС</NAME></STATICS><STATICS><ID>60</ID><NAME>Автоматизированные зоны самообслуживания</NAME></STATICS><STATICS><ID>59</ID><NAME>Операционная касса</NAME></STATICS><STATICS><ID>58</ID><NAME>Ведение обезличенных металлических счетов клиента</NAME></STATICS><STATICS><ID>57</ID><NAME>Аренда индивидуальных сейфовых ячеек</NAME></STATICS><STATICS><ID>56</ID><NAME>Операции с монетами и  драгоценными металлами</NAME></STATICS><STATICS><ID>55</ID><NAME>Длительные поручения</NAME></STATICS><STATICS><ID>54</ID><NAME>Переводы в рублях и иностранной валюте</NAME></STATICS><STATICS><ID>53</ID><NAME>Операции с ценными бумагами</NAME></STATICS><STATICS><ID>52</ID><NAME>Обменный пункт</NAME></STATICS><STATICS><ID>51</ID><NAME>Коммунальные платежи</NAME></STATICS><STATICS><ID>87</ID><NAME>Сочетание плановой и реальной истории договора</NAME></STATICS><STATICS><ID>50</ID><NAME>Кассовые операции</NAME></STATICS><STATICS><ID>49</ID><NAME>Технология взаимодействия вкладов и кредитов</NAME></STATICS><STATICS><ID>48</ID><NAME>Зарплатные проекты</NAME></STATICS><STATICS><ID>47</ID><NAME>Эквайринг</NAME></STATICS><STATICS><ID>46</ID><NAME>Особенности кредита на покупку автомобиля</NAME></STATICS><STATICS><ID>45</ID><NAME>Настройка бухгалтерских моделей операций кредитования в соответствии с учетной политикой Заказчика</NAME></STATICS><STATICS><ID>44</ID><NAME>Большая библиотека бизнес-процессов кредитования</NAME></STATICS><STATICS><ID>43</ID><NAME>Плановые графики и реальная история событий в жизненном цикле договора. Анализ эффективности применения кредитных продуктов</NAME></STATICS><STATICS><ID>42</ID><NAME>Использование различных видов лимитов в кредитных линиях</NAME></STATICS><STATICS><ID>41</ID><NAME>Ведение кредитных договоров в полном соответствии с нормативными требованиями ЦБ РФ</NAME></STATICS><STATICS><ID>86</ID><NAME>Бухгалтерские модели учета</NAME></STATICS><STATICS><ID>40</ID><NAME>Обработка заявок на кредитные договоры</NAME></STATICS><STATICS><ID>39</ID><NAME>Большой выбор типов кредитования для получения широкого спектра различных банковских продуктов</NAME></STATICS><STATICS><ID>38</ID><NAME>Назначение и основные характеристики xBank/Кредитование</NAME></STATICS><STATICS><ID>37</ID><NAME>Обслуживание пластиковых карт</NAME></STATICS><STATICS><ID>36</ID><NAME>Вклады (депозиты) физических лиц</NAME></STATICS><STATICS><ID>35</ID><NAME>Организация операционного рабочего дня</NAME></STATICS><STATICS><ID>34</ID><NAME>Функциональные возможности</NAME></STATICS><STATICS><ID>33</ID><NAME>Методы и средства разработки</NAME></STATICS><STATICS><ID>32</ID><NAME>Распределенная техническая архитектура</NAME></STATICS><STATICS><ID>31</ID><NAME>Режимы работы системы</NAME></STATICS><STATICS><ID>85</ID><NAME>Модели расчета сумм погашений</NAME></STATICS><STATICS><ID>30</ID><NAME>Использование свойств</NAME></STATICS><STATICS><ID>29</ID><NAME>Свойства объектов</NAME></STATICS><STATICS><ID>28</ID><NAME>Типовые операции</NAME></STATICS><STATICS><ID>27</ID><NAME>Типовые услуги</NAME></STATICS><STATICS><ID>26</ID><NAME>Банковские продукты и услуги</NAME></STATICS><STATICS><ID>25</ID><NAME>Базовые понятия</NAME></STATICS><STATICS><ID>24</ID><NAME>Функциональная архитектура</NAME></STATICS><STATICS><ID>23</ID><NAME>Описание бизнес-процессов в xBank</NAME></STATICS><STATICS><ID>22</ID><NAME>Назначение и основные характеристики xBank/Розничное обслуживание</NAME></STATICS><STATICS><ID>21</ID><NAME>Режимы работы системы</NAME></STATICS><STATICS><ID>84</ID><NAME>Лимитирование в типах кредитных линий</NAME></STATICS><STATICS><ID>20</ID><NAME>Централизованная система ведения и тиражирования НСИ</NAME></STATICS><STATICS><ID>19</ID><NAME>Свойства объектов</NAME></STATICS><STATICS><ID>18</ID><NAME>Описание технологической архитектуры системы</NAME></STATICS><STATICS><ID>17</ID><NAME>Обеспечение взаимодействия между рабочими местами АБС</NAME></STATICS><STATICS><ID>16</ID><NAME>Унификация описания типовых услуг</NAME></STATICS><STATICS><ID>15</ID><NAME>Типовые события</NAME></STATICS><STATICS><ID>14</ID><NAME>Регламент выполнения услуг</NAME></STATICS><STATICS><ID>13</ID><NAME>Типовые услуги</NAME></STATICS><STATICS><ID>12</ID><NAME>Банковские продукты и услуги</NAME></STATICS><STATICS><ID>11</ID><NAME>Субъекты отношений и сделки</NAME></STATICS><STATICS><ID>83</ID><NAME>Настройки банковских продуктов</NAME></STATICS><STATICS><ID>10</ID><NAME>Функциональные ресурсы</NAME></STATICS><STATICS><ID>9</ID><NAME>Организационные ресурсы</NAME></STATICS><STATICS><ID>8</ID><NAME>Технические ресурсы</NAME></STATICS><STATICS><ID>7</ID><NAME>Информационная безопасность</NAME></STATICS><STATICS><ID>6</ID><NAME>Описание xBank</NAME></STATICS><STATICS><ID>5</ID><NAME>Достоинства xBank</NAME></STATICS><STATICS><ID>4</ID><NAME>Координаты</NAME></STATICS><STATICS><ID>3</ID><NAME>Лицензии</NAME></STATICS><STATICS><ID>2</ID><NAME>О компании</NAME></STATICS><STATICS><ID>82</ID><NAME>Перечень объектов настройки</NAME></STATICS></L_STATIC_LIST></CLIENT_AREA>";
$xmlstr=utf8_encode(convert_cyr_string($xmlstr, "w", "i"));
if (!$dom = domxml_open_mem($xmlstr)) {
  echo "Error while parsing the document\n";
  exit;
}
else
{
echo"Tree ok!<br>";
}
//====================================
//получаем элемент в XML по относительному пути ($path) от текущего элемента($element)
//по умолчанию возвращает первый подходящий элемент
function ti_get_element_by_path($element, $str_path, $ar=array())
	{
	extract($ar);
	//eсли cnt_flag - возвращаем, сколько элементов и массив этих подходящих элементов

	$res_count=0;
	echo"ti_get_element_by_path($str_path)<br>";
	$count_up=substr_count($str_path, "../");

	//поднятие на нужное количество ступеней вверх
	//print_r($element);
	$tmp_element=$element;

	for($i=0; $i<$count_up; $i++)
		{
		$tmp_element=$tmp_element->parent_node();
		//echo"UP - ".$tmp_element->node_name()."<br>";
		}
	//echo"tmp_element<br>";
	//print_r($tmp_element);
	$str_path=str_replace("../", "", $str_path);
	$str_path_ar=explode("/", $str_path);
	$child = $tmp_element->child_nodes();
	//спуск на нужный уровень
	$count_path=count($str_path_ar);
	//for($i=0; $i<$count_path; $i++)
	//	{
		//echo"i=$i<br>";
		//перебор всех детей и сравнение по имени
		foreach ($child as $k_ch=>$v_ch)
			{
			//print("$k_ch. ". $child[$k_ch]->node_type(). " ". $child[$k_ch]->node_name()."<br/>");
			if($child[$k_ch]->node_name()==$str_path_ar[0])
				{
				if($count_path>1)
					{
					echo"str_path=$str_path<br>";
					//print_r($child[$k_ch]);
					$tmp_element=$child[$k_ch];
					//$child=array();
					//$child = $tmp_element->child_nodes();
					$tmp_ret=ti_get_element_by_path($tmp_element, str_replace($str_path_ar[0]."/", "", $str_path), $ar);
					if(!$cnt_flag)
						return $tmp_ret;
					else
						{
						$res_count+=$tmp_ret["count"];
						$res_element=array_merge($res_element, $tmp_ret["elements"]);
						}

					}
				else
					{
					$text=$child[$k_ch]->get_content();
					echo"<br>text2($k_ch) =$text<br>";
					//print_r($child[$k_ch]);
					if(!$cnt_flag)
						return $v_ch;
					else
						{
						$res_count++;
						$res_element[]=$v_ch;
						}
					}
				}
			}//конец foreach ($child as $k_ch=>$v_ch)
		//}
	if($cnt_flag)
		{
		return array("count"=>$res_count, "elements"=>$res_element);
		}
	//echo"ti_get_element_by_path END<br>";
	}
//конец ti_get_element_by_path
echo"CHILD 2<br>";
$elements = $dom->get_elements_by_tagname("CLIENT_AREA");
$element = $elements[0];
$str_path="L_STATIC_LIST/STATICS";
$find_el=ti_get_element_by_path($element, $str_path, array("cnt_flag"=>1));
//echo"find_el<br>";
//print_r($find_el);
echo"Count=".$find_el["count"]."<br>";
foreach ($find_el["elements"] as $k_ch=>$v_ch)
	{
	echo"<br>text 2 3($k_ch) =".$v_ch->get_content()."<br>";
	//добавляем новый узел
	$title1 = $v_ch->append_child($dom->create_element("title1"));

/* Функция create_text_node создаёт текстовый узел. Его добавим как содержимое 
	элемента title. Сохранять добавленный элемент в переменную необязательно - 
	только если вы хотите с ним после добавления работать. 
	надо не забыть перекодировать*/
$title1->append_child($dom->create_text_node("test text"));
	}


/*
$count_up=substr_count($str_path, "../");
//поднятие на нужное количество ступеней вверх
$tmp_element=$element;
for($i=0; $i<$count_up; $i++)
	{
	$tmp_element=$tmp_element->parent_node();
	}
$str_path=str_replace("../", "", $str_path);
$str_path_ar=explode("/", $str_path);
$child = $tmp_element->child_nodes();
//спуск на нужный уровень
$count_path=count($str_path_ar);
for($i=0; $i<$count_path; $i++)
	{
	//перебор всех детей и сравнение по имени
	foreach ($child as $k_ch=>$v_ch)
		{
		//print("$k_ch. ". $child[$k_ch]->node_type(). " ". $child[$k_ch]->node_name()."<br/>");
		if($child[$k_ch]->node_name()==$str_path_ar[$i])
			{
			if($i<($count_path-1))
				{
				print_r($child[$k_ch]);
				$tmp_element=$child[$k_ch];
				$child=array();
				$child = $tmp_element->child_nodes();
				break;
				}
			else
				{
				$text=$child[$k_ch]->get_content();
				echo"<br>text2($k_ch) =$text<br>";
				break;
				}
			}
		}
	}
*/
//-------------------
$xml_tmp=convert_cyr_string(utf8_decode($dom->dump_mem()), "i", "w");
echo "xml_tmp=$xml_tmp<br>";
?>